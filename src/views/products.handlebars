<h1>Catálogo de productos</h1>

<!-- FILTROS -->
<form method="GET" action="/products">
    <input type="hidden" name="cart" value="{{cartId}}">

    <select name="query">
        <option value="">Todas las categorías</option>

        {{#each categories}}
        <option value="{{this}}" {{#ifEquals this ../selectedCategory}}selected{{/ifEquals}}>
            {{this}}
        </option>
        {{/each}}

        <option value="available" {{#ifEquals "available" selectedCategory}}selected{{/ifEquals}}>
            Solo disponibles
        </option>
    </select>

    <select name="sort">
        <option value="">Sin orden</option>

        <option value="asc" {{#ifEquals "asc" selectedSort}}selected{{/ifEquals}}>
            Precio ascendente
        </option>

        <option value="desc" {{#ifEquals "desc" selectedSort}}selected{{/ifEquals}}>
            Precio descendente
        </option>
    </select>

    <button type="submit">Filtrar</button>
</form>

<hr>

<p>Página {{page}} de {{totalPages}}</p>

<!-- LISTA DE PRODUCTOS -->
<ul>
    {{#each products}}
        <li>
            <strong>{{this.name}}</strong>
            <br>
            Precio: ${{this.price}}
            <br>
            Stock: {{this.stock}}
            <br>

            <!-- mantener carrito al ir al detalle -->
            <a href="/products/{{this._id}}?cart={{../cartId}}">
                Ver detalle
            </a>

            <button onclick="addToCart('{{this._id}}')">
                Agregar al carrito
            </button>

            <hr>
        </li>
    {{/each}}
</ul>

<!-- PAGINACIÓN -->
<div>
    {{#if hasPrevPage}}
        <a href="{{prevLink}}&cart={{cartId}}">⬅ Página anterior</a>
    {{/if}}

    {{#if hasNextPage}}
        <a href="{{nextLink}}&cart={{cartId}}">Página siguiente ➡</a>
    {{/if}}
</div>

<script>
async function addToCart(productId) {
    try {
        const cartId = "{{cartId}}";

        const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
            method: "POST"
        });

        if (!response.ok) {
            throw new Error("Error al agregar producto");
        }

        alert("Producto agregado al carrito");

    } catch (error) {
        console.error(error);
        alert("No se pudo agregar el producto");
    }
}
</script>